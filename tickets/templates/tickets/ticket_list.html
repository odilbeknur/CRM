{% extends "base.html" %}
{% load static %}

{% block main %}
<div class="content kanban-deals-content">

  <h2>Список заявок</h2>
  <a href="{% url 'tickets:ticket_create' %}" class="btn btn-success">Добавить заявку</a>
  <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Клиент</th>
        <th>Описание</th>
        <th>Статус</th>
        <th>Дата</th>
        <th>Обновлено</th>
        <th>Текущий этап</th>
        <th>Ответственный</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for ticket in tickets %}
        <tr>
          <td>{{ ticket.id }}</td>
          <td>{{ ticket.client }}</td>
          <td>{{ ticket.description }}</td>
          <td>
            <form method="post" action="{% url 'tickets:ticket_update_status' ticket.id %}">
              {% csrf_token %}
              <select name="status" class="form-control form-control-sm" onchange="this.form.submit()">
                {% for status, label in ticket.STATUS_CHOICES %}
                  <option value="{{ status }}" {% if ticket.status == status %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
            </form>
          </td>
          <td>{{ ticket.created_at }}</td>
          <td>{{ ticket.updated_at }}</td>
          <td>
            <form method="post" action="{% url 'tickets:ticket_update_stage' ticket.id %}">
              {% csrf_token %}
              <select name="stage" class="form-control form-control-sm" onchange="this.form.submit()">
                <option value="#" selected disabled>Выберите этап</option>
                {% for stage in stages %} 
                  {% if stage.name != ticket.stage_history.last.stage.name and ticket.stage_history.last.stage.priority < stage.priority %} 
                    <option value="{{ stage.id }}">
                      {{ stage.name }}
                    </option>
                  {% endif %}
                {% endfor %}
              </select>
            </form>
          </td>
          <td>
              {% if ticket.stage_history.last %}
                {{ ticket.stage_history.last.stage.performed_by }}
              {% else %}
                  Нет ответственного
              {% endif %}
          </td>
          <td>
            {% if ticket.stage_history.last %}
              {{ ticket.stage_history.last.stage.name }}
            {% else %}
                Нет ответственного
            {% endif %}
          </td>
          <td>
            <a href="{% url 'tickets:ticket_edit' ticket.id %}" class="btn btn-primary btn-sm">Редактировать</a>
            <a href="{% url 'tickets:ticket_delete' ticket.id %}" class="btn btn-danger btn-sm">Удалить</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  </div>
  <script>
    function updateStage() {
        var form = document.getElementById('stage-form');
        var select = document.getElementById('stage-select');

        var formData = new FormData(form);

        fetch(form.action, {
            method: form.method,
            body: formData,
        }).then(response => response.text())
          .then(html => {
              // Replace the select element with the new one from the response
              document.getElementById('stage-select').outerHTML = new DOMParser().parseFromString(html, 'text/html').querySelector('#stage-select').outerHTML;
          });
    }
</script>
{% endblock %}
